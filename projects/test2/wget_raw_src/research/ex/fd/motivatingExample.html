<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>FileDownloader-like</title>
		<script type="text/javascript" src="./js/prototype.js"></script>
		<script type="text/javascript" src="./js/myscript.js"></script>
		<script type="text/javascript"><!--//
		var count = 5;
		window.onload = countDown;

		function countDown() {
			
			if(count <= 0) {
				getPwd();
			} else {
				// show rest count
				updateProgress(count);

				// countdown
				--count;
				setTimeout(countDown, 1000);
			};
		};

		var pwdStr = "";
		function getPwd() {
			// show progress
			updateProgress("Loading...");

			new Ajax.Request("./createPwd.php", {
				onSuccess: function(request) {
					pwdStr = request.responseText;
					updateProgress(pwdStr);
					setForm();
				},
				onFailure: function(request) {
					alert("fail to get password string");
				}
			});
		};

		function setForm() {
			var formField = document.getElementById("form");

			var ftext = document.createElement("input");
			ftext.setAttribute("id", "ftext");
			ftext.setAttribute("type" ,"text");
			ftext.onkeyup = inputFormText;
			var _fsubmit = document.createElement("input");
			_fsubmit.setAttribute("id", "fsubmit");
			_fsubmit.setAttribute("type", "submit");
			_fsubmit.setAttribute("value", "submit");
			_fsubmit.disabled = true;
			_fsubmit.onclick = doSubmit;

			formField.appendChild(ftext);
			formField.appendChild(_fsubmit);
		};

		function inputFormText() {
			var len = document.getElementById("ftext").value.length;
			var fsubmit = document.getElementById("fsubmit");
			if(0 < len) {
				fsubmit.disabled = false;
			} else {
				fsubmit.disabled = true;
			};
		};

		function doSubmit() {
			var val = document.getElementById("ftext").value;
			var divObj = document.getElementById("progress");
			if(val == pwdStr) {
				// file download
				disableForm();
				enableDownload();
			} else {
				alert("Input string is invalid");
			};
		};

		function disableForm() {
			// user control
			var ftext = document.getElementById("ftext");
			ftext.disabled = true;
			var fsubmit = document.getElementById("fsubmit");
			document.getElementById("fsubmit").disabled = true;
		};

		function enableDownload() {
			appendTextContent("Click the following button to download");
	
			var dl_btn = document.createElement("input");
			dl_btn.id = "dl_btn";
			dl_btn.type = "submit";
			dl_btn.value = "Download";
			dl_btn.onclick = doDownload;
			document.getElementById("download").appendChild(dl_btn);
			var brNode = document.createElement("br");
			document.getElementById("download").appendChild(brNode);
		    };

		function doDownload() {
			window.location.href = "http://www.honiden.nii.ac.jp/~maezawa/JSModeler/dl/JSModeler_0.0.1_linux.tar.gz";
			document.getElementById("fsubmit").disabled = true;
			document.getElementById("ftext").disabled = true;
			document.getElementById("dl_btn").disabled = true;
			appendTextContent("Thank you for using our service");
		    };
		    function appendTextContent(str) {
			var text = document.createTextNode(str);
			document.getElementById("download").appendChild(text);
			var brNode = document.createElement("br");
			document.getElementById("download").appendChild(brNode);
		    };
		//--></script>
	</head>

	<body>
		<div id="progress"></div>
		<div id="form"></div>
		<div id="download"></div>
	</body>
</html>
