<html>
<head>
<title>QAsite</title>
<link href="css/base.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/prototype.js"></script>
<script type="text/javascript" src="js/jshash/md5.js"></script>
<script type="text/javascript"><!--//
/**
 * We implement QAsite
 * by referring to Ajax Design Patterns, which was introduced by Michael Mahemoff (mahemoff.com).
 *
 * Note that we extendedly leverage the patterns;
 * For example, asynchronous communications using prototype.js (prototypejs.org)
 */

/**
 * Variables for Direct Login Pattern
 */
var LOGIN_PREFIX = "login.php";
var loggedIn;
var hasSeed;
var seed_id;
var seed;

/**
 * User Action Pattern
 * Should register user event handlers at page load
 */
window.onload = function() {
	loggedIn = false;
	hasSeed = false;

	document.getElementById("username").onfocus = getSeed;
	document.getElementById("password").onfocus = getSeed;
	document.getElementById("login").onmousedown = validateLogin;		
	document.getElementById("good").onclick = onGood;
}

/**
 * On-Demand JavaScript Patterns
 * This onGood should be called after successful login
 * which depends on the result of asynchronous communications
 * for users to attempt the login by using Direct Login Pattern
 */
function onGood() {
	var n = parseInt($("good_num").innerHTML);
	$("good_num").innerHTML = ++n;
}
 
/**
 * Direct Login Pattern
 */
function getSeed() {
	if(!loggedIn && !hasSeed) {
		new Ajax.Request(LOGIN_PREFIX, {
			method: 'GET',
			parameters: 'task=getseed',
			onSuccess: handleHttpGetSeed
		});
	}
}
function handleHttpGetSeed(res) {
	var results = res.responseText.split('|');
 	seed_id = results[0];
	seed = results[1];	
	hasSeed = true;
}
function validateLogin() {
	var username = $("username").value;
	var password = $("password").value;

	hash = hex_md5(hex_md5(password).concat(seed));

	new Ajax.Request(LOGIN_PREFIX, {
		method: 'GET',
		parameters: 'task=checklogin&username='+username+'&id='+seed_id+'&hash='+hash,
		onComplete: tryLogin
	});
}
/// End of Direct Login Pattern

function tryLogin(res) {
	if(isSuccess(res)) {
		successLogin(res);
	} else {
		alert(res.responseText);
		//alert("Invalid account");
	}
}
function isSuccess(res) {
	var results = res.responseText.split('|');
	if(results[0] == "true") {
		return true;
	} else {
		return false;
	}
}
function getFullname(res) {
	var results = res.responseText.split('|');
	return results[1];
}
function successLogin(res) {
	disableLoginForm(res);
	makeAnswerReabable();
	
	loggedIn = true;
}

/**
 * Direct Login Pattern
 */
function disableLoginForm(res) {
	// create logout anchor
	$("message").innerText = "Logged in as ";
	var elm_fn = document.createElement("b");
	elm_fn.id = "fullname";
	elm_fn.innerText = getFullname(res);
	$("message").appendChild(elm_fn);

	$("message").appendChild(document.createTextNode(" ["));
	
	// create logout anchor
	var elm_logout = document.createElement("a");
	elm_logout.innerText = "logout";
	elm_logout.id = "logout";
	elm_logout.onmouseup = tryLogout;
	
	$("message").appendChild(elm_logout);
	$("message").appendChild(document.createTextNode("]"));
	
	// disable form
	var u = document.getElementById("username");
	u.disabled = true;
	
	var p = document.getElementById("password");
	p.disabled = true;
	
	var l = document.getElementById("login");
	l.disabled = true;
	document.getElementById("login").style.display = "none";
}

// On-Demand JavaScript Pattern
// by masking
function makeAnswerReabable() {
	var mask = $("mask");
	mask.style.display = "none";
}

// for logout
function tryLogout() {
	enableLoginForm();
	makeAnswerMasked();
	
	loggedIn = false;
	hasSeed = false;
}

function enableLoginForm() {
	// disable logout anchor
	var elm_logout = document.getElementById("logout");
	elm_logout.disabled = true;
	
	// enable login form
	var u = document.getElementById("username");
	u.disabled = false;
	u.value = "";
	
	var p = document.getElementById("password");
	p.disabled = false;
	p.value = "";
	
	var l = document.getElementById("login");
	l.disabled = false;
	document.getElementById("login").style.display = "inline";

	$("message").innerText = "To read answers more, enter your username and password to log in.";
}

function makeAnswerMasked() {
	var mask = $("mask");
	mask.style.display = "block";
}
//--></script>
</head>
<body>

<div id="header">
<h1>QAsite</h1>
</div>

<div id="content">

<div id="div_left">
<h2>Question</h2>
<div id="question">
<span id="question_title">What is ASE 2014?</span>
<div id="questioner_property">
<label>Questioner: </label><span id="questioner">Yuta Maezawa</span><br />
<label>Date: </label><span id="question_date">April 28, 2014 12:00 GMT</span>
</div>
<div id="question_content">
<p>What is ASE 2014? As you all know that ASE is the greatest conference on software engineering, I would like to know details of the conference this year.</p>
</div>
</div>

<!-- masked for guest users  -->
<div id="answers">
<h2>Answers</h2>

<div id="answer">
<div id="answerer_property">
<label>Answerer: </label><span id="questioner">ASE 2014 conference website</span><br />
<label>Date: </label><span id="question_date">April 28, 2014 13:00 GMT</span>
</div>
<div id="answer_content">
<img id="conf-header" src="img/conf-header.jpg" />
<p>The IEEE/ACM Automated Software Engineering (ASE) Conference series is the premier research forum for automated software engineering.
Each year, it brings together researchers and practitioners from academia and industry
to discuss foundations, techniques and tools for automating the analysis, design, implementation, testing, and maintenance of large software systems.
</p>
<p>Visit the ASE 2014 Website, <a href="http://ase2014.org/">http://ase2014.org/</a></p> 
</div>
<div id="answer_footer">
<button id="good">Good!</button>
<span id="good_num">0</span>
</div>
</div>

<div id="mask"></div>
</div><!-- end of #answer -->

</div>

<div id="div_right">
<!-- disabled without login -->
<h2>Login/out</h2>
<div id="login_div" class="login">
<p id="message">To read answers more, enter your username and password to log in.</p>
<label for="username">Username: </label><br />
<input name="username" id="username" size="20" type="text" /><br />
<label for="password">Password: </label><br />
<input name="password" id="password" size="20" type="password" /><br />
<input name="login" id="login" value="login" type="submit" />
</div>

</div>
</div>

<div id="footer">
<label>QAsite (c), 2014. </label>
</div>

</body>
</html>
